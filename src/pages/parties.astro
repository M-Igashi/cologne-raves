---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import PartyCard from '../components/PartyCard.astro';
import { getAllParties } from '../lib/getAllParties';

const allParties = await getAllParties();

// Europe/Berlin タイムゾーンで今週月曜00:00を取得
const now = new Date();
const berlinNow = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Berlin' }));

const day = berlinNow.getDay();
const diff = (day + 6) % 7; // 月曜基準で0
berlinNow.setHours(0, 0, 0, 0);
const thisMonday = new Date(berlinNow);
thisMonday.setDate(berlinNow.getDate() - diff);

// thisMonday 以降のイベントだけを抽出
const futureParties = allParties.filter(p => new Date(p.date) >= thisMonday);

// 月別にグループ化
const partiesByMonth: Record<string, typeof futureParties> = {};
for (const party of futureParties) {
  const month = party.date.slice(0, 7); // "YYYY-MM"
  if (!partiesByMonth[month]) {
    partiesByMonth[month] = [];
  }
  partiesByMonth[month].push(party);
}

const sortedMonthKeys = Object.keys(partiesByMonth).sort();

// SEO関連の変数
const totalParties = futureParties.length;
const monthCount = sortedMonthKeys.length;
const title = `All Upcoming Parties (${totalParties} Events) - Cologne Electronic Music Calendar`;
const description = `Browse ${totalParties} upcoming techno and electronic music events in Cologne across ${monthCount} months. Complete calendar of underground raves, club nights, and electronic music parties with venue details and DJ lineups.`;
const keywords = "cologne electronic music calendar, all techno parties köln, upcoming raves cologne, electronic events calendar cologne, techno club nights köln, complete party guide cologne";
const canonicalURL = new URL(Astro.url.pathname, "https://cologne.ravers.workers.dev").href;
---

<html lang="en" class="dark">
  <head>
    <BaseHead
      title={title}
      description={description}
      keywords={keywords}
      canonicalURL={canonicalURL}
    />
  </head>
  <body style="min-height: 100vh; background: #000000; color: #ffffff; max-width: 768px; margin: 0 auto; padding: 32px 24px; display: flex; flex-direction: column;">
    <Header active="all-parties" />

    {/* Event Submission Banner */}
    <div style="background: #111111; border: 1px solid #333333; padding: 20px; margin-bottom: 24px;">
      <h2 style="font-size: 0.85rem; font-weight: 700; color: #ffffff; margin-bottom: 4px;">Got an event coming up?</h2>
      <p style="font-size: 0.75rem; color: #888888; margin: 0;">Submit your party or live show to our community calendar using the button above!</p>
    </div>

    <main style="flex: 1;">
      <nav style="display: flex; gap: 12px; margin-bottom: 24px;" aria-label="Event filters">
        <a href="/" style="padding: 10px 20px; background: transparent; color: #ffffff; text-decoration: none; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; border: 1px solid #ffffff; font-family: 'JetBrains Mono', monospace;">This Week</a>
        <a href="/parties" style="padding: 10px 20px; background: #ffffff; color: #000000; text-decoration: none; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; border: 1px solid #ffffff; font-family: 'JetBrains Mono', monospace;">All Parties</a>
      </nav>

      <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 2px;">All Upcoming Parties</h2>

      {
        sortedMonthKeys.map(month => (
          <section>
            <h3 style="font-size: 1rem; font-weight: 700; margin-top: 40px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #333333; text-transform: uppercase; letter-spacing: 2px;">{month}</h3>
            {
              partiesByMonth[month].map(party => (
                <PartyCard {...party} />
              ))
            }
          </section>
        ))
      }
    </main>
  </body>
</html>
