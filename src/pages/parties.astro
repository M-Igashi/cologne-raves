---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PartyCard from '../components/PartyCard.astro';
import { getAllParties } from '../lib/getAllParties';
import { toZonedTime } from 'date-fns-tz';
import { startOfWeek } from 'date-fns';

const parties = await getAllParties();

// フィルタ: 今週の月曜 00:00 (Europe/Berlin) 以降のイベントのみ
const berlinNow = toZonedTime(new Date(), 'Europe/Berlin');
const weekStart = startOfWeek(berlinNow, { weekStartsOn: 1 }); // 月曜

const upcomingParties = parties.filter((party) => {
  const partyDate = new Date(party.date);
  return partyDate >= weekStart;
});

// グループ化: 月単位
const partiesByMonth: Record<string, typeof upcomingParties> = {};

for (const party of upcomingParties) {
  const date = new Date(party.date);
  const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
  if (!partiesByMonth[yearMonth]) {
    partiesByMonth[yearMonth] = [];
  }
  partiesByMonth[yearMonth].push(party);
}
---

<html lang="en">
  <head>
    <BaseHead title="All Parties | Cologne Raves" />
  </head>
  <body class="min-h-screen flex flex-col">
    <Header active="all-parties" />
    <main class="max-w-3xl mx-auto p-4 flex-1">
      <h1 class="text-2xl font-semibold mb-4">All Parties</h1>

      {
        Object.keys(partiesByMonth).sort().map((month) => (
          <section>
            <h2 class="text-xl font-semibold mt-6 mb-2">{month}</h2>
            {
              partiesByMonth[month].map((party) => (
                <PartyCard {...party} />
              ))
            }
          </section>
        ))
      }
    </main>
    <Footer />
  </body>
</html>