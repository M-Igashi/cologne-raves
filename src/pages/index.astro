---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PartyCard from '../components/PartyCard.astro';
import { getFeaturedParties } from '../lib/getFeaturedParties';
import { startOfWeek, endOfWeek } from 'date-fns';
import { toZonedTime } from 'date-fns-tz';

const parties = await getFeaturedParties();

// Group by weekday
const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const partiesByDay: Record<string, typeof parties> = {};

for (const party of parties) {
  const date = new Date(party.date);
  const weekday = weekdays[date.getDay()];
  if (!partiesByDay[weekday]) {
    partiesByDay[weekday] = [];
  }
  partiesByDay[weekday].push(party);
}

// SEO関連の変数 - 週の日付を含める (getFeaturedPartiesと同じ月曜始まり+ベルリンTZ)
const berlinNow = toZonedTime(new Date(), 'Europe/Berlin');
const weekStart = startOfWeek(berlinNow, { weekStartsOn: 1 });
const weekEnd = endOfWeek(berlinNow, { weekStartsOn: 1 });

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

const weekRange = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
const title = `This Week (${weekRange}) - Electronic Music Events in Cologne`;
const description = `Discover the best techno and electronic music events happening this week (${weekRange}) in Cologne. Find ${parties.length} parties with dates, venues, DJs lineups and ticket information for underground raves and club nights.`;
const keywords = "cologne techno this week, köln electronic music events, techno parties cologne weekend, house music cologne, rave events köln, underground techno cologne, club nights cologne";
const canonicalURL = new URL(Astro.url.pathname, "https://cologne.ravers.workers.dev").href;
---

<html lang="en" class="dark">
  <head>
    <BaseHead
      title={title}
      description={description}
      canonicalURL={canonicalURL}
      keywords={keywords}
    />
  </head>
  <body style="min-height: 100vh; background: #000000; color: #ffffff; max-width: 768px; margin: 0 auto; padding: 32px 24px; display: flex; flex-direction: column;">
    <Header active="this-week" />

    {/* Event Submission Banner */}
    <div style="background: #111111; border: 1px solid #333333; padding: 20px; margin-bottom: 24px;">
      <h2 style="font-size: 0.85rem; font-weight: 700; color: #ffffff; margin-bottom: 4px;">Got an event coming up?</h2>
      <p style="font-size: 0.75rem; color: #888888; margin: 0;">Submit your party or live show to our community calendar using the button above!</p>
    </div>

    <main style="flex: 1;" role="main" itemscope itemtype="https://schema.org/EventSeries">
      <nav style="display: flex; gap: 12px; margin-bottom: 24px;" aria-label="Event filters">
        <a href="/" style="padding: 10px 20px; background: #ffffff; color: #000000; text-decoration: none; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; border: 1px solid #ffffff; font-family: 'JetBrains Mono', monospace;" aria-current="page">This Week</a>
        <a href="/parties" style="padding: 10px 20px; background: transparent; color: #ffffff; text-decoration: none; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; border: 1px solid #ffffff; font-family: 'JetBrains Mono', monospace;">All Parties</a>
      </nav>

      <h1 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 2px;" itemprop="name">Electronic Music Events This Week in Cologne</h1>
      <meta itemprop="description" content={description} />
      <meta itemprop="location" content="Cologne, Germany" />

      {
        ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map((day) => (
          partiesByDay[day]?.length > 0 && (
            <section>
              <h3 style="font-size: 1rem; font-weight: 700; margin-top: 32px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #333333; text-transform: uppercase; letter-spacing: 2px;">{day}</h3>
              {
                partiesByDay[day].map((party) => (
                  <PartyCard {...party} showEditLink={false} />
                ))
              }
            </section>
          )
        ))
      }
    </main>
    <Footer />
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "d2f09f5d6b604f4e9986c797f43be1bc"}'></script><!-- End Cloudflare Web Analytics -->
  </body>
</html>
