---
import { CalendarDays, Clock, Headphones, GitBranch } from 'lucide-react';
const {
  id,
  title,
  venue,
  date,
  startTime,
  artists,
  url,
  sourceFile,
  showEditLink = true
} = Astro.props;

// Create start and end date times
const startDateTime = `${date}T${startTime ?? '23:00'}:00+01:00`;
// Default end time to 3 hours after start time if not specified
const endTime = startTime ? 
  String(Math.floor((parseInt(startTime.split(':')[0]) + 3) % 24)).padStart(2, '0') + ':00' : 
  '02:00';
const endDateTime = `${date}T${endTime}:00+01:00`;

// Default event image
const defaultImage = "https://cologne.ravers.workers.dev/og-cover.png";
---

<article class="rounded-xl border p-4 mb-4 relative">
  <div class="absolute top-2 right-4 text-xs text-muted-foreground">#{id}</div>

  <h2 class="font-semibold">
    {title}{venue && ` @ ${venue}`}
  </h2>

  <p class="flex items-center gap-1 mt-1 text-sm text-muted-foreground">
    <CalendarDays class="size-4" />
    {new Date(date).toLocaleDateString('en-US', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    })}
    {startTime && (
      <>
        <span class="inline-block w-1" />â€“<Clock class="size-4" />
        {startTime}
      </>
    )}
  </p>

  {artists?.length > 0 && (
    <p class="flex items-center gap-1 mt-1 text-sm text-muted-foreground">
      <Headphones class="size-4" />
      {artists.join(', ')}
    </p>
  )}

  {url && (
    <p class="mt-2 text-sm">
      <a
        href={url}
        class="underline underline-offset-2"
        target="_blank"
        rel="noopener noreferrer"
      >
        More Info
      </a>
    </p>
  )}

  {showEditLink && sourceFile && (
    <p class="mt-2 text-sm flex items-center gap-1 text-muted-foreground">
      <GitBranch class="size-4" />
      <a
        href={`https://github.com/M-Igashi/cologne-raves/edit/main/data/${sourceFile}`}
        class="underline underline-offset-2"
        target="_blank"
        rel="noopener noreferrer"
      >
        Edit on GitHub
      </a>
    </p>
  )}

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Event",
    "name": title,
    "description": `${title}${venue ? ` at ${venue}` : ''} - Electronic music event in Cologne${artists?.length > 0 ? ` featuring ${artists.join(', ')}` : ''}`,
    "startDate": startDateTime,
    "endDate": endDateTime,
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
      "@type": "Place",
      "name": venue || "Cologne",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Cologne",
        "addressRegion": "North Rhine-Westphalia", 
        "addressCountry": "DE"
      }
    },
    "image": defaultImage,
    "organizer": {
      "@type": "Organization",
      "name": "Cologne Ravers",
      "url": "https://cologne.ravers.workers.dev"
    },
    "performer": artists?.length > 0 ? artists.map(name => ({
      "@type": "Person",
      "name": name
    })) : undefined,
    "offers": {
      "@type": "Offer",
      "url": url || `https://cologne.ravers.workers.dev/#event-${id}`,
      "availability": "https://schema.org/InStock",
      "validFrom": new Date().toISOString().split('T')[0], // Today's date
      "price": "Varies",
      "priceCurrency": "EUR"
    },
    "url": url || `https://cologne.ravers.workers.dev/#event-${id}`
  })} />
</article>