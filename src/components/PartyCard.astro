---
import { CalendarDays, Clock, Headphones, GitBranch } from 'lucide-react';
const {
  id,
  title,
  venue,
  date,
  startTime,
  artists,
  url,
  sourceFile,
  showEditLink = true
} = Astro.props;

// Create start and end date times
const startDateTime = `${date}T${startTime ?? '23:00'}:00+01:00`;
// Default end time to 3 hours after start time if not specified
const endTime = startTime ?
  String(Math.floor((parseInt(startTime.split(':')[0]) + 3) % 24)).padStart(2, '0') + ':00' :
  '02:00';
const endDateTime = `${date}T${endTime}:00+01:00`;

// Default event image
const defaultImage = "https://cologne.ravers.workers.dev/og-cover.png";
---

<article style="background: #111111; border: 1px solid #333333; padding: 20px; margin-bottom: 16px; position: relative;">
  <div style="position: absolute; top: 12px; right: 16px; font-size: 0.7rem; color: #888888; text-transform: uppercase; letter-spacing: 1px;">#{id}</div>

  <h2 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
    {title}{venue && ` @ ${venue}`}
  </h2>

  <p class="flex items-center gap-1 mt-1" style="font-size: 0.8rem; color: #888888;">
    <CalendarDays class="size-4" />
    {new Date(date).toLocaleDateString('en-US', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    })}
    {startTime && (
      <>
        <span class="inline-block w-1" />â€“<Clock class="size-4" />
        {startTime}
      </>
    )}
  </p>

  {artists?.length > 0 && (
    <p class="flex items-center gap-1 mt-1" style="font-size: 0.8rem; color: #888888;">
      <Headphones class="size-4" />
      {artists.join(', ')}
    </p>
  )}

  {url && (
    <p style="margin-top: 10px; font-size: 0.75rem;">
      <a
        href={url}
        style="color: #ffffff; text-decoration: none; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #888888; padding-bottom: 2px;"
        target="_blank"
        rel="noopener noreferrer"
      >
        More Info
      </a>
    </p>
  )}

  {showEditLink && sourceFile && (
    <p class="flex items-center gap-1" style="margin-top: 10px; font-size: 0.75rem; color: #888888;">
      <GitBranch class="size-4" />
      <a
        href={`https://github.com/M-Igashi/cologne-raves/edit/main/data/${sourceFile}`}
        style="color: #888888; text-decoration: none; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333333; padding-bottom: 2px;"
        target="_blank"
        rel="noopener noreferrer"
      >
        Edit on GitHub
      </a>
    </p>
  )}

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Event",
    "name": title,
    "description": `${title}${venue ? ` at ${venue}` : ''} - Electronic music event in Cologne${artists?.length > 0 ? ` featuring ${artists.join(', ')}` : ''}`,
    "startDate": startDateTime,
    "endDate": endDateTime,
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
      "@type": "Place",
      "name": venue || "Cologne",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Cologne",
        "addressRegion": "North Rhine-Westphalia",
        "addressCountry": "DE"
      }
    },
    "image": defaultImage,
    "organizer": {
      "@type": "Organization",
      "name": "Cologne Ravers",
      "url": "https://cologne.ravers.workers.dev"
    },
    ...(artists?.length > 0 ? {
      "performer": artists.map(name => ({
        "@type": "Person",
        "name": name
      }))
    } : {}),
    "offers": {
      "@type": "Offer",
      "url": url || `https://cologne.ravers.workers.dev/#event-${id}`,
      "availability": "https://schema.org/InStock",
      "validFrom": new Date().toISOString().split('T')[0],
      "price": "0",
      "priceCurrency": "EUR",
      "description": "Prices may vary at the door. Check event link for details."
    },
    "url": url || `https://cologne.ravers.workers.dev/#event-${id}`
  })} />
</article>
